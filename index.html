<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Easy Route - Sistema de Rutas Mototaxis</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin=""/>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin=""></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }
        .header { background: white; padding: 20px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .header-content { max-width: 1400px; margin: 0 auto; }
        h1 { color: #667eea; font-size: 1.8em; margin-bottom: 5px; }
        .subtitle { color: #666; font-size: 0.95em; }
        .container { max-width: 1400px; margin: 20px auto; padding: 0 20px; }
        .main-grid { display: grid; grid-template-columns: 380px 1fr; gap: 20px; }
        .control-panel {
            background: white; border-radius: 15px; padding: 25px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2); height: fit-content;
        }
        .map-container {
            background: white; border-radius: 15px; overflow: hidden;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2); position: relative;
        }
        #map { height: 650px; width: 100%; }
        .section-title { font-size: 1.3em; color: #667eea; margin-bottom: 20px; font-weight: 600; }
        .form-group { margin-bottom: 20px; }
        label { display: block; font-weight: 600; margin-bottom: 8px; color: #333; font-size: 0.95em; }
        select {
            width: 100%; padding: 12px; border: 2px solid #e0e0e0;
            border-radius: 8px; font-size: 1em; transition: all 0.3s;
        }
        select:focus {
            outline: none; border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }
        .btn-calculate {
            width: 100%; padding: 15px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white; border: none; border-radius: 8px;
            font-size: 1.1em; font-weight: 600; cursor: pointer; transition: all 0.3s;
        }
        .btn-calculate:hover { transform: translateY(-2px); box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4); }
        .results { margin-top: 25px; display: none; }
        .results.show { display: block; animation: slideIn 0.3s ease; }
        @keyframes slideIn {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .result-card {
            background: #f8f9fa; padding: 15px; border-radius: 8px;
            margin-bottom: 12px; border-left: 4px solid #667eea;
        }
        .result-label { font-size: 0.85em; color: #666; margin-bottom: 5px; }
        .result-value { font-size: 1.3em; font-weight: 600; color: #333; }
        .ruta-info {
            background: white; padding: 15px; border-radius: 8px; margin-top: 15px;
            border: 2px solid #e0e0e0; max-height: 300px; overflow-y: auto;
        }
        .ruta-stat {
            display: flex; justify-content: space-between;
            padding: 8px 0; border-bottom: 1px solid #f0f0f0;
        }
        .legend {
            position: absolute; bottom: 20px; right: 20px; background: white;
            padding: 15px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.2);
            z-index: 1000; font-size: 0.85em;
        }
        .legend-title { font-weight: 600; margin-bottom: 10px; }
        .legend-item { display: flex; align-items: center; margin-bottom: 5px; }
        .legend-color { width: 20px; height: 20px; border-radius: 50%; margin-right: 8px; }
    </style>
</head>
<body>
    <div class="header">
        <div class="header-content">
            <h1>üõµ Easy Route - Sistema de Optimizaci√≥n de Rutas</h1>
            <p class="subtitle">Sistematizaci√≥n del Flujo de Mototaxistas - Puente Piedra y Carabayllo, Lima</p>
        </div>
    </div>
    
    <div class="container">
        <div class="main-grid">
            <div class="control-panel">
                <h2 class="section-title">üìç Planificar Ruta</h2>
                
                <div class="form-group">
                    <label for="origen">üü¢ Punto de Origen</label>
                    <select id="origen"><option value="">-- Seleccione origen --</option></select>
                </div>
                
                <div class="form-group">
                    <label for="destino">üî¥ Punto de Destino</label>
                    <select id="destino"><option value="">-- Seleccione destino --</option></select>
                </div>
                
                <button class="btn-calculate" onclick="calcularRuta()">üîç Calcular Ruta √ìptima</button>
                
                <button class="btn-calculate" onclick="toggleModoReporte()" id="btn-reporte"
                        style="background: #f39c12; margin-top: 10px;">
                    üö® Activar Modo Reporte de Tr√°fico
                </button>
                
                <div style="margin-top: 15px;">
                    <label style="display: flex; align-items: center; font-size: 0.9em; cursor: pointer;">
                        <input type="checkbox" id="modo_seguro" style="margin-right: 8px;">
                        üõ°Ô∏è Modo Calles Seguras
                    </label>
                    <label style="display: flex; align-items: center; font-size: 0.9em; cursor: pointer; margin-top: 8px;">
                        <input type="checkbox" id="evitar_congestion" style="margin-right: 8px;" checked>
                        üö¶ Evitar Zonas con Tr√°fico
                    </label>
                </div>
                
                <div id="info-reporte" style="display: none; background: #fff3cd; padding: 12px; border-radius: 6px; margin-top: 15px; font-size: 0.9em;">
                    <strong>üö® Modo Reporte Activo</strong><br>Haz click en el mapa donde hay tr√°fico
                </div>
                
                <div id="results" class="results">
                    <div class="result-card">
                        <div class="result-label">‚è±Ô∏è Tiempo Estimado</div>
                        <div class="result-value" id="tiempo">-- min</div>
                    </div>
                    <div class="result-card">
                        <div class="result-label">üìè Distancia Total</div>
                        <div class="result-value" id="distancia">-- m</div>
                    </div>
                    <div class="result-card">
                        <div class="result-label">üíµ Tarifa Estimada</div>
                        <div class="result-value" id="tarifa">S/ --</div>
                    </div>
                    <div class="ruta-info">
                        <div class="ruta-stat"><span>üìä Total de pasos:</span><strong id="pasos">--</strong></div>
                        <div class="ruta-stat"><span>üö¶ Esquinas cruzadas:</span><strong id="esquinas">--</strong></div>
                        <div class="ruta-stat"><span>‚ö° Velocidad promedio:</span><strong id="velocidad">-- km/h</strong></div>
                        <div class="ruta-stat" style="border-top: 2px solid #e0e0e0; padding-top: 10px; margin-top: 10px;">
                            <span>üí° Desglose de tarifa:</span>
                            <div style="font-size: 0.85em; margin-top: 5px; color: #666;">
                                <div>‚Ä¢ Base: S/ 3.00</div>
                                <div id="tarifa_detalle">‚Ä¢ Por distancia: S/ --<br>‚Ä¢ Por tiempo: S/ --</div>
                            </div>
                        </div>
                    </div>
                    <div style="background: #fff3cd; border-left: 4px solid #ffc107; padding: 12px; border-radius: 6px; margin-top: 15px; font-size: 0.9em;">
                        <strong>üí° Tip del Conductor:</strong><br>
                        <span id="tip_conductor">Calcula tu ruta para ver recomendaciones</span>
                    </div>
                </div>
            </div>
            
            <div class="map-container">
                <div id="map"></div>
                <div class="legend">
                    <div class="legend-title">Leyenda</div>
                    <div class="legend-item">
                        <div class="legend-color" style="background: #e74c3c;"></div><span>POIs (Destinos)</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color" style="background: #95a5a6;"></div><span>Esquinas</span>
                    </div>
                    <div class="legend-item">
                        <div style="width: 20px; height: 4px; background: red; margin-right: 8px;"></div>
                        <span>Ruta calculada</span>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <script>
        let map, nodos = {}, grafo = {}, todosLosMarcadores = [], capasRuta = [];
        let reportesTraficoCapa = [], zonasConReportes = new Set(), modoReporte = false;
        
        async function cargarGrafo() {
            try {
                const response = await fetch('grafo_web.json');
                if (!response.ok) throw new Error('JSON no encontrado');
                const datos = await response.json();
                nodos = datos.nodos;
                grafo = datos.grafo;
                console.log(`‚úÖ Grafo cargado: ${Object.keys(nodos).length} nodos`);
            } catch (error) {
                alert('Error: No se pudo cargar grafo_web.json');
                return;
            }
            poblarSelectores();
            inicializarMapa();
        }
        
        function poblarSelectores() {
            const selectOrigen = document.getElementById('origen');
            const selectDestino = document.getElementById('destino');
            const pois = Object.keys(nodos).filter(id => nodos[id].tipo === 'poi');
            pois.forEach(id => {
                const opt1 = document.createElement('option');
                opt1.value = id;
                opt1.textContent = nodos[id].nombre;
                selectOrigen.appendChild(opt1);
                const opt2 = document.createElement('option');
                opt2.value = id;
                opt2.textContent = nodos[id].nombre;
                selectDestino.appendChild(opt2);
            });
        }
        
        function inicializarMapa() {
            map = L.map('map').setView([-11.8550, -77.0670], 13);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '¬© OpenStreetMap',
                maxZoom: 19
            }).addTo(map);
            
            map.on('click', e => { if (modoReporte) reportarTrafico(e.latlng); });
            
            for (let nodo1 in grafo) {
                for (let nodo2 in grafo[nodo1]) {
                    L.polyline(
                        [[nodos[nodo1].lat, nodos[nodo1].lon], [nodos[nodo2].lat, nodos[nodo2].lon]],
                        { color: '#bdc3c7', weight: 1, opacity: 0.3 }
                    ).addTo(map);
                }
            }
            
            simularTraficoCongestionado();
            
            Object.keys(nodos).forEach(id => {
                const nodo = nodos[id];
                if (nodo.tipo === 'esquina') {
                    L.circleMarker([nodo.lat, nodo.lon], {
                        radius: 2, fillColor: '#95a5a6', color: '#fff',
                        weight: 1, opacity: 0.5, fillOpacity: 0.5
                    }).addTo(map);
                } else if (nodo.tipo === 'poi') {
                    const marker = L.circleMarker([nodo.lat, nodo.lon], {
                        radius: 8, fillColor: '#e74c3c', color: '#fff',
                        weight: 2, opacity: 1, fillOpacity: 0.9
                    }).addTo(map);
                    marker.bindPopup(`<b>${nodo.nombre}</b>`);
                    todosLosMarcadores.push(marker);
                }
            });
            console.log('‚úÖ Mapa inicializado');
        }
        
        function simularTraficoCongestionado() {
            const esquinas = Object.keys(nodos).filter(id => nodos[id].tipo === 'esquina');
            const num = Math.floor(Math.random() * 20) + 20;
            for (let i = 0; i < num; i++) {
                zonasConReportes.add(esquinas[Math.floor(Math.random() * esquinas.length)]);
            }
            actualizarVisualizacionReportes();
        }
        
        function toggleModoReporte() {
            modoReporte = !modoReporte;
            const btn = document.getElementById('btn-reporte');
            const info = document.getElementById('info-reporte');
            if (modoReporte) {
                btn.textContent = '‚úÖ Modo Reporte ACTIVO';
                btn.style.background = '#27ae60';
                info.style.display = 'block';
                map.getContainer().style.cursor = 'crosshair';
            } else {
                btn.textContent = 'üö® Activar Modo Reporte de Tr√°fico';
                btn.style.background = '#f39c12';
                info.style.display = 'none';
                map.getContainer().style.cursor = '';
            }
        }
        
        function reportarTrafico(latlng) {
            let minDist = Infinity, nodoMasCercano = null;
            Object.keys(nodos).forEach(id => {
                const nodo = nodos[id];
                if (nodo.tipo === 'esquina') {
                    const dist = Math.sqrt(
                        Math.pow((nodo.lat - latlng.lat) * 111000, 2) +
                        Math.pow((nodo.lon - latlng.lng) * 111000 * Math.cos(latlng.lat * Math.PI / 180), 2)
                    );
                    if (dist < minDist) { minDist = dist; nodoMasCercano = id; }
                }
            });
            if (nodoMasCercano && minDist < 500) {
                zonasConReportes.add(nodoMasCercano);
                actualizarVisualizacionReportes();
                L.popup().setLatLng([nodos[nodoMasCercano].lat, nodos[nodoMasCercano].lon])
                    .setContent(`<div style="text-align: center;"><strong>üö® Tr√°fico Reportado</strong><br><small>Radio: ${Math.round(minDist)}m</small></div>`)
                    .openOn(map);
                const orig = document.getElementById('origen').value;
                const dest = document.getElementById('destino').value;
                if (orig && dest && orig !== dest) setTimeout(() => calcularRuta(), 1500);
            }
        }
        
        function actualizarVisualizacionReportes() {
            reportesTraficoCapa.forEach(c => map.removeLayer(c));
            reportesTraficoCapa = [];
            zonasConReportes.forEach(id => {
                if (nodos[id]) {
                    const c = L.circleMarker([nodos[id].lat, nodos[id].lon], {
                        radius: 10, fillColor: '#ffc107', color: '#ff9800',
                        weight: 3, opacity: 1, fillOpacity: 0.8
                    }).addTo(map);
                    reportesTraficoCapa.push(c);
                }
            });
        }
        
        function dijkstra(origen, destino) {
            const dist = {}, prev = {}, vis = new Set(), pend = new Set(Object.keys(nodos));
            const seguro = document.getElementById('modo_seguro')?.checked || false;
            const evitar = document.getElementById('evitar_congestion')?.checked || false;
            
            for (let n of pend) { dist[n] = Infinity; prev[n] = null; }
            dist[origen] = 0;
            
            while (pend.size > 0) {
                let act = null, menorD = Infinity;
                for (let n of pend) if (dist[n] < menorD) { menorD = dist[n]; act = n; }
                if (act === null || menorD === Infinity) break;
                if (act === destino) break;
                pend.delete(act);
                
                if (grafo[act]) {
                    for (let vec in grafo[act]) {
                        if (!vis.has(vec)) {
                            let t = grafo[act][vec].tiempo;
                            if (seguro && nodos[vec].tipo === 'esquina') {
                                const numV = Object.keys(grafo[vec] || {}).length;
                                if (numV <= 2) t *= 1.5;
                            }
                            if (evitar && zonasConReportes.has(vec)) t *= 3.0;
                            const newD = dist[act] + t;
                            if (newD < dist[vec]) { dist[vec] = newD; prev[vec] = act; }
                        }
                    }
                }
                vis.add(act);
            }
            
            const ruta = [];
            let a = destino;
            while (a !== null) { ruta.unshift(a); a = prev[a]; }
            return { ruta, tiempo: dist[destino] };
        }
        
        function calcularRuta() {
            const orig = document.getElementById('origen').value;
            const dest = document.getElementById('destino').value;
            if (!orig || !dest) { alert('Seleccione origen y destino'); return; }
            if (orig === dest) { alert('Origen y destino deben ser diferentes'); return; }
            
            const { ruta, tiempo } = dijkstra(orig, dest);
            if (ruta.length === 0 || tiempo === Infinity) { alert('No se encontr√≥ ruta'); return; }
            
            let distTotal = 0;
            for (let i = 0; i < ruta.length - 1; i++) {
                if (grafo[ruta[i]] && grafo[ruta[i]][ruta[i+1]]) {
                    distTotal += grafo[ruta[i]][ruta[i+1]].dist;
                }
            }
            
            const esq = ruta.filter(id => nodos[id].tipo === 'esquina').length;
            const velProm = distTotal > 0 ? ((distTotal / 1000) / (tiempo / 60)).toFixed(1) : 0;
            const tBase = 3.00, tDist = Math.min(5, (distTotal / 1000) * 2);
            const tTime = Math.min(5, tiempo * 0.15), tTotal = tBase + tDist + tTime;
            
            let tip = "Ruta √≥ptima.";
            if (tiempo > 15) tip = "‚ö†Ô∏è Ruta larga. Considera parada intermedia.";
            else if (distTotal < 500) tip = "‚úÖ Ruta corta ideal.";
            else if (esq > 20) tip = "üö¶ Muchas esquinas. Precauci√≥n.";
            
            document.getElementById('tiempo').textContent = `${tiempo.toFixed(1)} min`;
            document.getElementById('distancia').textContent = `${distTotal} m`;
            document.getElementById('tarifa').textContent = `S/ ${tTotal.toFixed(2)}`;
            document.getElementById('pasos').textContent = ruta.length;
            document.getElementById('esquinas').textContent = esq;
            document.getElementById('velocidad').textContent = `${velProm} km/h`;
            document.getElementById('tarifa_detalle').innerHTML = `‚Ä¢ Por distancia: S/ ${tDist.toFixed(2)}<br>‚Ä¢ Por tiempo: S/ ${tTime.toFixed(2)}`;
            document.getElementById('tip_conductor').textContent = tip;
            document.getElementById('results').classList.add('show');
            
            dibujarRuta(ruta);
        }
        
        function dibujarRuta(ruta) {
            capasRuta.forEach(c => map.removeLayer(c));
            capasRuta = [];
            
            // ‚úÖ CORRECCI√ìN: Polyline continua que respeta TODAS las esquinas
            const coords = ruta.map(id => [nodos[id].lat, nodos[id].lon]);
            
            const lineaPrincipal = L.polyline(coords, {
                color: '#e74c3c', weight: 6, opacity: 0.7,
                lineJoin: 'round', lineCap: 'round'
            }).addTo(map);
            capasRuta.push(lineaPrincipal);
            
            const lineaDeco = L.polyline(coords, {
                color: '#ffffff', weight: 2, opacity: 0.6,
                dashArray: '10, 10', dashOffset: '0'
            }).addTo(map);
            capasRuta.push(lineaDeco);
            
            let offset = 0;
            const anim = setInterval(() => {
                offset += 2;
                lineaDeco.setStyle({ dashOffset: offset.toString() });
            }, 100);
            setTimeout(() => clearInterval(anim), 10000);
            
            map.fitBounds(coords, { padding: [50, 50] });
            
            const inicio = L.marker([nodos[ruta[0]].lat, nodos[ruta[0]].lon], {
                icon: L.divIcon({
                    html: '<div style="background: #27ae60; color: white; padding: 6px 10px; border-radius: 5px; font-weight: bold;">üèÅ INICIO</div>',
                    iconSize: [80, 30], iconAnchor: [40, 30]
                })
            }).addTo(map);
            capasRuta.push(inicio);
            
            const fin = L.marker([nodos[ruta[ruta.length-1]].lat, nodos[ruta[ruta.length-1]].lon], {
                icon: L.divIcon({
                    html: '<div style="background: #e74c3c; color: white; padding: 6px 10px; border-radius: 5px; font-weight: bold;">üéØ DESTINO</div>',
                    iconSize: [100, 30], iconAnchor: [50, 30]
                })
            }).addTo(map);
            capasRuta.push(fin);
            
            ruta.forEach((id, idx) => {
                if (idx > 0 && idx < ruta.length - 1 && nodos[id].tipo === 'esquina') {
                    const m = L.circleMarker([nodos[id].lat, nodos[id].lon], {
                        radius: 5, fillColor: '#f39c12', color: '#fff',
                        weight: 2, opacity: 1, fillOpacity: 0.9
                    }).addTo(map);
                    capasRuta.push(m);
                }
            });
        }
        
        window.addEventListener('load', () => {
            setTimeout(() => {
                if (typeof L !== 'undefined') cargarGrafo();
                else alert('Error: No se pudo cargar Leaflet');
            }, 100);
        });
    </script>
</body>
</html>
