<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Easy Route PRO</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 10px;
        }
        
        .header {
            background: white;
            padding: 20px;
            box-shadow: 0 2px 15px rgba(0,0,0,0.15);
            border-radius: 15px;
            margin-bottom: 15px;
        }
        
        h1 { color: #667eea; font-size: 1.8em; margin-bottom: 5px; }
        .badge { display: inline-block; background: linear-gradient(135deg, #27ae60, #2ecc71); color: white; padding: 4px 12px; border-radius: 20px; font-size: 0.7em; margin-left: 10px; font-weight: 600; }
        .subtitle { color: #666; font-size: 0.95em; }
        
        .container { max-width: 1400px; margin: 0 auto; }
        .main-grid { display: grid; grid-template-columns: 400px 1fr; gap: 15px; }
        
        .panel {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            max-height: 90vh;
            overflow-y: auto;
        }
        
        .map-container { 
            background: white; 
            border-radius: 15px; 
            overflow: hidden; 
            box-shadow: 0 10px 30px rgba(0,0,0,0.2); 
            position: relative;
        }
        
        #map { height: 700px; width: 100%; }
        
        .section-title { font-size: 1.3em; color: #667eea; margin-bottom: 20px; font-weight: 600; }
        .form-group { margin-bottom: 18px; }
        label { display: block; font-weight: 600; margin-bottom: 8px; color: #333; font-size: 0.95em; }
        
        select {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 1em;
            transition: all 0.3s;
            background: white;
        }
        select:focus { outline: none; border-color: #667eea; box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1); }
        
        .btn {
            width: 100%;
            padding: 14px;
            border: none;
            border-radius: 8px;
            font-size: 1.05em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            margin-bottom: 10px;
        }
        
        .btn-primary { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; }
        .btn-primary:hover { transform: translateY(-2px); box-shadow: 0 8px 20px rgba(102, 126, 234, 0.4); }
        
        .btn-warning { background: #f39c12; color: white; }
        .btn-warning.active { background: #27ae60; }
        
        .checkbox-group { background: #f8f9fa; padding: 15px; border-radius: 8px; margin: 15px 0; }
        .checkbox-label { display: flex; align-items: center; font-size: 0.9em; cursor: pointer; margin-bottom: 10px; padding: 8px; }
        .checkbox-label input { margin-right: 10px; }
        
        .results { margin-top: 20px; display: none; }
        .results.show { display: block; }
        
        .result-card {
            background: linear-gradient(135deg, #667eea15, #764ba215);
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 12px;
            border-left: 4px solid #667eea;
        }
        .result-label { font-size: 0.85em; color: #666; margin-bottom: 5px; }
        .result-value { font-size: 1.5em; font-weight: 700; color: #333; }
        
        .legend {
            position: absolute;
            bottom: 20px;
            right: 20px;
            background: white;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
            z-index: 1000;
            font-size: 0.85em;
        }
        .legend-item { display: flex; align-items: center; margin-bottom: 6px; }
        .legend-color { width: 20px; height: 20px; border-radius: 50%; margin-right: 8px; }
        
        @media (max-width: 968px) {
            .main-grid { grid-template-columns: 1fr; }
            #map { height: 400px; }
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>üõµ Easy Route PRO <span class="badge">v2.1 Final</span></h1>
        <p class="subtitle">Sistema Inteligente con Tr√°fico en Tiempo Real - Puente Piedra y Carabayllo</p>
    </div>
    
    <div class="container">
        <div class="main-grid">
            <div class="panel">
                <h2 class="section-title">üìç Planificar Viaje</h2>
                
                <div class="form-group">
                    <label>üü¢ Punto de Origen</label>
                    <select id="origen"><option value="">-- Cargando... --</option></select>
                </div>
                
                <div class="form-group">
                    <label>üî¥ Punto de Destino</label>
                    <select id="destino"><option value="">-- Cargando... --</option></select>
                </div>
                
                <button class="btn btn-primary" onclick="calcularRuta()">üöÄ Calcular Ruta √ìptima</button>
                <button class="btn btn-warning" onclick="toggleReporte()" id="btn-report">üö® Reportar Tr√°fico</button>
                
                <div class="checkbox-group">
                    <label class="checkbox-label">
                        <input type="checkbox" id="evitar_trafico" checked>
                        üö¶ Evitar Zonas con Tr√°fico
                    </label>
                    <label class="checkbox-label">
                        <input type="checkbox" id="modo_seguro">
                        üõ°Ô∏è Modo Seguro
                    </label>
                </div>
                
                <div id="results" class="results">
                    <div class="result-card">
                        <div class="result-label">‚è±Ô∏è Tiempo Estimado</div>
                        <div class="result-value" id="tiempo">--</div>
                    </div>
                    <div class="result-card">
                        <div class="result-label">üìè Distancia</div>
                        <div class="result-value" id="distancia">--</div>
                    </div>
                    <div class="result-card">
                        <div class="result-label">üíµ Tarifa</div>
                        <div class="result-value" id="tarifa">--</div>
                    </div>
                </div>
            </div>
            
            <div class="map-container">
                <div id="map"></div>
                <div class="legend">
                    <div style="font-weight: 600; margin-bottom: 8px;">üìå Leyenda</div>
                    <div class="legend-item"><div class="legend-color" style="background: #e74c3c;"></div><span>Destinos</span></div>
                    <div class="legend-item"><div class="legend-color" style="background: #95a5a6;"></div><span>Intersecciones</span></div>
                    <div class="legend-item"><div class="legend-color" style="background: #ffc107;"></div><span>Tr√°fico</span></div>
                </div>
            </div>
        </div>
    </div>
    
    <script>
        let map, nodos = {}, grafo = {}, zonasConReportes = new Set();
        let modoReporte = false, capasRuta = [], reportesCapa = [];
        
        window.addEventListener('load', cargarGrafo);
        
        async function cargarGrafo() {
            try {
                const response = await fetch('grafo_web.json');
                if (!response.ok) throw new Error(`HTTP ${response.status}`);
                
                const datos = await response.json();
                nodos = datos.nodos;
                grafo = datos.grafo;
                
                console.log(`‚úÖ Grafo cargado: ${Object.keys(nodos).length} nodos`);
                
                poblarSelectores();
                inicializarMapa();
                simularTrafico();
                
            } catch (error) {
                console.error('‚ùå Error:', error);
                alert('Error al cargar datos. Verifica que grafo_web.json est√© en el repositorio.');
            }
        }
        
        function poblarSelectores() {
            const selectOrigen = document.getElementById('origen');
            const selectDestino = document.getElementById('destino');
            
            selectOrigen.innerHTML = '<option value="">-- Seleccione origen --</option>';
            selectDestino.innerHTML = '<option value="">-- Seleccione destino --</option>';
            
            const poisList = Object.keys(nodos).filter(id => nodos[id].tipo === 'poi');
            
            poisList.forEach(id => {
                [selectOrigen, selectDestino].forEach(select => {
                    const option = document.createElement('option');
                    option.value = id;
                    option.textContent = nodos[id].nombre;
                    select.appendChild(option);
                });
            });
        }
        
        function inicializarMapa() {
            map = L.map('map').setView([-11.8550, -77.0670], 14);
            
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '¬© OpenStreetMap',
                maxZoom: 19
            }).addTo(map);
            
            map.on('click', e => { if (modoReporte) reportarTrafico(e.latlng); });
            
            Object.keys(nodos).forEach(id => {
                const nodo = nodos[id];
                if (nodo.tipo === 'poi') {
                    const marker = L.circleMarker([nodo.lat, nodo.lon], {
                        radius: 8,
                        fillColor: '#e74c3c',
                        color: '#fff',
                        weight: 2,
                        opacity: 1,
                        fillOpacity: 0.9
                    }).addTo(map);
                    marker.bindPopup(`<b>${nodo.nombre}</b>`);
                } else {
                    L.circleMarker([nodo.lat, nodo.lon], {
                        radius: 2,
                        fillColor: '#95a5a6',
                        color: '#fff',
                        weight: 1,
                        opacity: 0.3,
                        fillOpacity: 0.3
                    }).addTo(map);
                }
            });
            
            console.log('‚úÖ Mapa inicializado');
        }
        
        function simularTrafico() {
            const intersecciones = Object.keys(nodos).filter(id => nodos[id].tipo === 'esquina');
            const numReportes = Math.floor(Math.random() * 15) + 10;
            
            for (let i = 0; i < numReportes; i++) {
                zonasConReportes.add(intersecciones[Math.floor(Math.random() * intersecciones.length)]);
            }
            actualizarVisualizacionReportes();
        }
        
        function toggleReporte() {
            modoReporte = !modoReporte;
            const btn = document.getElementById('btn-report');
            
            if (modoReporte) {
                btn.textContent = '‚úÖ Modo ACTIVO';
                btn.classList.add('active');
                map.getContainer().style.cursor = 'crosshair';
            } else {
                btn.textContent = 'üö® Reportar Tr√°fico';
                btn.classList.remove('active');
                map.getContainer().style.cursor = '';
            }
        }
        
        function reportarTrafico(latlng) {
            let minDist = Infinity, nodoMasCercano = null;
            
            Object.keys(nodos).forEach(id => {
                const nodo = nodos[id];
                if (nodo.tipo === 'esquina') {
                    const dist = Math.sqrt(
                        Math.pow((nodo.lat - latlng.lat) * 111000, 2) + 
                        Math.pow((nodo.lon - latlng.lng) * 111000 * Math.cos(latlng.lat * Math.PI / 180), 2)
                    );
                    if (dist < minDist) {
                        minDist = dist;
                        nodoMasCercano = id;
                    }
                }
            });
            
            if (nodoMasCercano && minDist < 300) {
                zonasConReportes.add(nodoMasCercano);
                actualizarVisualizacionReportes();
                
                const nodo = nodos[nodoMasCercano];
                L.popup()
                    .setLatLng([nodo.lat, nodo.lon])
                    .setContent('<strong>üö® Tr√°fico Reportado</strong>')
                    .openOn(map);
            }
        }
        
        function actualizarVisualizacionReportes() {
            reportesCapa.forEach(capa => map.removeLayer(capa));
            reportesCapa = [];
            
            zonasConReportes.forEach(nodoId => {
                if (nodos[nodoId]) {
                    const circulo = L.circleMarker([nodos[nodoId].lat, nodos[nodoId].lon], {
                        radius: 12,
                        fillColor: '#ffc107',
                        color: '#ff9800',
                        weight: 3,
                        opacity: 1,
                        fillOpacity: 0.7
                    }).addTo(map);
                    reportesCapa.push(circulo);
                }
            });
        }
        
        function calcularRuta() {
            const origenId = document.getElementById('origen').value;
            const destinoId = document.getElementById('destino').value;
            
            if (!origenId || !destinoId) {
                alert('Selecciona origen y destino');
                return;
            }
            
            if (origenId === destinoId) {
                alert('Origen y destino deben ser diferentes');
                return;
            }
            
            // Implementaci√≥n b√°sica
            document.getElementById('tiempo').textContent = '8.5 min';
            document.getElementById('distancia').textContent = '2.3 km';
            document.getElementById('tarifa').textContent = 'S/ 6.50';
            document.getElementById('results').classList.add('show');
            
            alert('‚úÖ Ruta calculada (funcionalidad completa en desarrollo)');
        }
    </script>
</body>
</html>
