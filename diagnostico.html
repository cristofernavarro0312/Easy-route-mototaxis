<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Easy Route - Diagn√≥stico</title>
</head>
<body style="font-family: Arial; padding: 40px; background: #f5f5f5;">
    <div style="max-width: 800px; margin: 0 auto; background: white; padding: 30px; border-radius: 10px; box-shadow: 0 5px 20px rgba(0,0,0,0.1);">
        <h1 style="color: #667eea;">üõµ Easy Route - Diagn√≥stico</h1>
        
        <div id="status" style="margin: 20px 0; padding: 20px; background: #fff3cd; border-left: 4px solid #ffc107; border-radius: 5px;">
            <h3>‚è≥ Verificando archivos...</h3>
            <p>Espera un momento...</p>
        </div>
        
        <div id="details" style="margin-top: 20px; font-family: monospace; font-size: 12px; background: #f8f9fa; padding: 15px; border-radius: 5px; max-height: 400px; overflow-y: auto;"></div>
        
        <button onclick="location.reload()" style="margin-top: 20px; padding: 12px 24px; background: #667eea; color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 600; font-size: 14px;">
            üîÑ Volver a verificar
        </button>
    </div>
    
    <script>
        const log = [];
        const detailsDiv = document.getElementById('details');
        const statusDiv = document.getElementById('status');
        
        function addLog(msg, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const colors = {
                'error': '#dc3545',
                'success': '#28a745',
                'info': '#667eea',
                'warning': '#ff9800'
            };
            const color = colors[type] || colors.info;
            
            log.push(`[${timestamp}] ${msg}`);
            detailsDiv.innerHTML += `<div style="color: ${color}; margin: 5px 0; padding: 5px; border-left: 3px solid ${color}; padding-left: 10px;">${msg}</div>`;
            console.log(msg);
        }
        
        async function verificarTodo() {
            addLog('üöÄ Iniciando verificaci√≥n completa...', 'info');
            addLog('', 'info');
            
            // Test 1: Verificar que Leaflet se carg√≥
            addLog('üì¶ TEST 1: Verificando librer√≠a Leaflet...', 'info');
            if (typeof L !== 'undefined') {
                addLog('‚úÖ Leaflet cargado correctamente (versi√≥n disponible)', 'success');
            } else {
                addLog('‚ùå ERROR: Leaflet no se carg√≥ (problema de CDN)', 'error');
            }
            addLog('', 'info');
            
            // Test 2: Verificar URLs
            addLog('üåê TEST 2: Verificando URLs...', 'info');
            addLog(`   üìç P√°gina actual: ${window.location.href}`, 'info');
            const jsonURL = window.location.origin + window.location.pathname.replace(/\/[^\/]*$/, '/') + 'grafo_web.json';
            addLog(`   üìç URL esperada del JSON: ${jsonURL}`, 'info');
            addLog('', 'info');
            
            // Test 3: Intentar cargar grafo_web.json
            addLog('üìÇ TEST 3: Intentando cargar grafo_web.json...', 'info');
            
            try {
                const startTime = Date.now();
                const response = await fetch('grafo_web.json');
                const loadTime = Date.now() - startTime;
                
                addLog(`üì° Respuesta recibida en ${loadTime}ms`, 'info');
                addLog(`üìä Status: ${response.status} ${response.statusText}`, response.ok ? 'success' : 'error');
                addLog(`üìä Headers:`, 'info');
                
                response.headers.forEach((value, key) => {
                    addLog(`   ‚Ä¢ ${key}: ${value}`, 'info');
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                addLog('', 'info');
                addLog('üìÑ TEST 4: Parseando JSON...', 'info');
                const data = await response.json();
                addLog(`‚úÖ JSON parseado correctamente`, 'success');
                addLog(`üìä Tama√±o del objeto: ${JSON.stringify(data).length} caracteres`, 'info');
                addLog('', 'info');
                
                addLog('üìä TEST 5: Analizando estructura de datos...', 'info');
                
                if (data.nodos) {
                    const nodosArray = Object.keys(data.nodos);
                    addLog(`‚úÖ Propiedad 'nodos' encontrada: ${nodosArray.length} nodos`, 'success');
                    
                    // Contar POIs y esquinas
                    let pois = 0, esquinas = 0;
                    nodosArray.forEach(id => {
                        if (data.nodos[id].tipo === 'poi') pois++;
                        if (data.nodos[id].tipo === 'esquina') esquinas++;
                    });
                    
                    addLog(`   ‚Ä¢ POIs (destinos): ${pois}`, 'success');
                    addLog(`   ‚Ä¢ Esquinas (intersecciones): ${esquinas}`, 'success');
                    
                    if (nodosArray.length > 0) {
                        addLog(`   ‚Ä¢ Primeros 5 nodos: ${nodosArray.slice(0, 5).join(', ')}`, 'info');
                        
                        // Mostrar ejemplo de un POI
                        const primerPOI = nodosArray.find(id => data.nodos[id].tipo === 'poi');
                        if (primerPOI) {
                            const poi = data.nodos[primerPOI];
                            addLog(`   ‚Ä¢ Ejemplo de POI: ${poi.nombre} (lat: ${poi.lat}, lon: ${poi.lon})`, 'info');
                        }
                    }
                } else {
                    addLog(`‚ùå ERROR: No se encontr√≥ la propiedad 'nodos'`, 'error');
                }
                
                if (data.grafo) {
                    const grafoArray = Object.keys(data.grafo);
                    addLog(`‚úÖ Propiedad 'grafo' encontrada: ${grafoArray.length} nodos con conexiones`, 'success');
                    
                    // Contar conexiones totales
                    let totalConexiones = 0;
                    grafoArray.forEach(nodo => {
                        totalConexiones += Object.keys(data.grafo[nodo]).length;
                    });
                    addLog(`   ‚Ä¢ Total de conexiones: ${totalConexiones}`, 'success');
                } else {
                    addLog(`‚ùå ERROR: No se encontr√≥ la propiedad 'grafo'`, 'error');
                }
                
                addLog('', 'info');
                addLog('üéâ ¬°TODOS LOS TESTS PASARON!', 'success');
                
                statusDiv.innerHTML = `
                    <h3 style="color: #28a745;">‚úÖ DIAGN√ìSTICO EXITOSO</h3>
                    <p><strong>Resultado:</strong> El archivo <code>grafo_web.json</code> est√° correctamente ubicado y tiene datos v√°lidos.</p>
                    <p><strong>Datos encontrados:</strong></p>
                    <ul style="text-align: left;">
                        <li>${pois} destinos (POIs)</li>
                        <li>${esquinas} intersecciones</li>
                        <li>${totalConexiones} conexiones entre nodos</li>
                    </ul>
                    <p style="margin-top: 15px; padding: 15px; background: #d4edda; border-radius: 5px;">
                        <strong>‚úÖ Conclusi√≥n:</strong> El problema est√° en el c√≥digo del <code>index.html</code>, NO en el archivo JSON.<br>
                        <strong>Soluci√≥n:</strong> Te dar√© una versi√≥n corregida del HTML que funcione con estos datos.
                    </p>
                `;
                
            } catch (error) {
                addLog(`‚ùå ERROR CR√çTICO: ${error.message}`, 'error');
                addLog(`   Stack: ${error.stack}`, 'error');
                
                statusDiv.innerHTML = `
                    <h3 style="color: #dc3545;">‚ùå ERROR AL CARGAR ARCHIVO</h3>
                    <p><strong>Problema:</strong> ${error.message}</p>
                    <p><strong>Posibles causas:</strong></p>
                    <ol style="text-align: left; padding-left: 20px;">
                        <li>El archivo NO se subi√≥ correctamente a GitHub</li>
                        <li>GitHub Pages no se activ√≥ correctamente</li>
                        <li>El nombre del archivo es incorrecto (debe ser exactamente "grafo_web.json")</li>
                        <li>Esperando que GitHub actualice (espera 2-3 minutos m√°s)</li>
                    </ol>
                    <p style="margin-top: 15px; padding: 15px; background: #f8d7da; border-radius: 5px;">
                        <strong>üîß Soluci√≥n recomendada:</strong><br>
                        1. Verifica que el archivo est√© en: <code>https://github.com/cristofernavarro0312/Easy-route-mototaxis/blob/main/grafo_web.json</code><br>
                        2. Espera 2-3 minutos<br>
                        3. Recarga esta p√°gina
                    </p>
                `;
            }
            
            addLog('', 'info');
            addLog('üìù Diagn√≥stico completado', 'info');
        }
        
        // Cargar Leaflet y ejecutar tests
        addLog('üîß Cargando dependencias...', 'info');
        
        const leafletCSS = document.createElement('link');
        leafletCSS.rel = 'stylesheet';
        leafletCSS.href = 'https://unpkg.com/leaflet@1.9.4/dist/leaflet.css';
        document.head.appendChild(leafletCSS);
        
        const leafletJS = document.createElement('script');
        leafletJS.src = 'https://unpkg.com/leaflet@1.9.4/dist/leaflet.js';
        leafletJS.onload = () => {
            addLog('‚úÖ Leaflet cargado desde CDN', 'success');
            addLog('', 'info');
            setTimeout(verificarTodo, 500);
        };
        leafletJS.onerror = () => {
            addLog('‚ùå Error al cargar Leaflet desde CDN', 'error');
            verificarTodo();
        };
        document.head.appendChild(leafletJS);
    </script>
</body>
</html>
